// netlify/functions/api/verify-2fa.js
const speakeasy = require("speakeasy");

exports.handler = async (event) => {
  try {
    const { code } = JSON.parse(event.body || "{}");

    if (!code) {
      console.error("‚ùå Aucun code 2FA re√ßu");
      return {
        statusCode: 400,
        body: JSON.stringify({ error: "Missing 2FA code" })
      };
    }

    const secret = process.env.TOTP_SECRET;
    if (!secret) {
      console.error("‚ùå TOTP_SECRET manquant dans les variables d'environnement");
      return {
        statusCode: 500,
        body: JSON.stringify({ error: "Missing TOTP secret" })
      };
    }

    const verified = speakeasy.totp.verify({
      secret,
      encoding: "base32",
      token: code,
      window: 1 // tol√©rance ¬±30s
    });

    console.log("üîê Code 2FA re√ßu:", code);
    console.log("‚úÖ V√©rification:", verified);

    if (!verified) {
      return {
        statusCode: 401,
        body: JSON.stringify({ error: "Invalid 2FA code" })
      };
    }

    return {
      statusCode: 200,
      body: JSON.stringify({ success: true })
    };

  } catch (err) {
    console.error("‚ùå Erreur dans verify-2fa.js:", err);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: "Internal Server Error", details: err.message })
    };
  }
};
