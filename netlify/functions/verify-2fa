// netlify/functions/api/verify-2fa.js
const speakeasy = require("speakeasy");
const jwt = require("jsonwebtoken");

exports.handler = async (event) => {
  try {
    // ‚úÖ M√©thode HTTP
    if (event.httpMethod !== "POST") {
      return {
        statusCode: 405,
        headers: { Allow: "POST" },
        body: JSON.stringify({ error: "Method Not Allowed" })
      };
    }

    // üîé Lecture du body
    let body;
    try {
      body = JSON.parse(event.body || "{}");
    } catch (err) {
      console.error("‚ùå Body JSON invalide:", err.message);
      return {
        statusCode: 400,
        body: JSON.stringify({ error: "Invalid request body" })
      };
    }

    const code = body.code;
    if (!code) {
      console.error("‚ùå Aucun code 2FA re√ßu");
      return {
        statusCode: 400,
        body: JSON.stringify({ error: "Missing 2FA code" })
      };
    }

    // ‚úÖ Variables d'environnement
    const secret = process.env.TOTP_SECRET;
    const jwtSecret = process.env.JWT_SECRET;
    if (!secret || !jwtSecret) {
      console.error("‚ùå Variables d'environnement manquantes:", { TOTP_SECRET: !!secret, JWT_SECRET: !!jwtSecret });
      return {
        statusCode: 500,
        body: JSON.stringify({ error: "Missing environment variables" })
      };
    }

    // üîé R√©cup√©ration du cookie JWT
    const rawCookies = event.headers.cookie || "";
    const cookies = rawCookies.split(";").map(c => c.trim()).filter(Boolean);

    const sessionPair = cookies.find(c => c.startsWith("session="));
    if (!sessionPair) {
      console.error("‚ùå Aucun cookie de session trouv√©");
      return {
        statusCode: 401,
        body: JSON.stringify({ error: "No session cookie found" })
      };
    }

    const token = sessionPair.slice("session=".length);
    let payload;
    try {
      payload = jwt.verify(token, jwtSecret);
    } catch (err) {
      console.error("‚ùå JWT invalide:", err.message);
      return {
        statusCode: 401,
        body: JSON.stringify({ error: "Invalid session token" })
      };
    }

    // ‚úÖ V√©rification du code TOTP
    const verified = speakeasy.totp.verify({
      secret,
      encoding: "base32",
      token: code,
      window: 1 // tol√©rance ¬±30s
    });

    console.log("üîê Code 2FA re√ßu:", code);
    console.log("‚úÖ V√©rification:", verified);

    if (!verified) {
      return {
        statusCode: 401,
        body: JSON.stringify({ error: "Invalid 2FA code" })
      };
    }

    // üîë Mise √† jour du JWT avec twoFA:true
    const newToken = jwt.sign(
      { email: payload.email, googleId: payload.googleId, twoFA: true },
      jwtSecret,
      { expiresIn: "15m" }
    );

    // ‚úÖ Redirection vers /admin avec nouveau cookie
    return {
      statusCode: 302,
      headers: {
        "Set-Cookie": [
          // tue l'ancien cookie si besoin
          `session=deleted; HttpOnly; Secure; Path=/; SameSite=Lax; Max-Age=0`,
          // pose le nouveau
          `session=${newToken}; HttpOnly; Secure; Path=/; SameSite=Lax`
        ].join(", "),
        "Cache-Control": "no-store",
        Location: "/admin"
      }
    };

  } catch (err) {
    console.error("‚ùå Erreur dans verify-2fa.js:", err);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: "Internal Server Error", details: err.message })
    };
  }
};


