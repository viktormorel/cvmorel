// netlify/functions/2fa-verify.mjs
import speakeasy from "speakeasy";
import jwt from "jsonwebtoken";

import { Handler, HandlerEvent, HandlerResponse } from '@netlify/functions';

export const handler: Handler = async (event: HandlerEvent): Promise<HandlerResponse> => {
  try {
    // Autoriser uniquement POST
    if (event.httpMethod !== "POST") {
      return {
        statusCode: 405,
        headers: { Allow: "POST" },
        body: JSON.stringify({ error: "Method Not Allowed" })
      };
    }

    // Lecture du body
    let body;
    try {
      body = JSON.parse(event.body || "{}");
    } catch {
      return { statusCode: 400, body: JSON.stringify({ error: "Invalid JSON body" }) };
    }

    const token = String(body.token || "").trim();
    if (!/^\d{6}$/.test(token)) {
      return { statusCode: 400, body: JSON.stringify({ error: "Code invalide" }) };
    }

    const jwtSecret = process.env.JWT_SECRET;
    if (!jwtSecret) {
      return { statusCode: 500, body: JSON.stringify({ error: "Missing JWT_SECRET" }) };
    }

    // Lecture du cookie JWT
    const rawCookies = event.headers.cookie || "";
    const sessionPair = rawCookies.split(";").map((c: string) => c.trim()).find((c: string) => c.startsWith("session="));
    if (!sessionPair) {
      return { statusCode: 401, body: JSON.stringify({ error: "No session cookie found" }) };
    }

    const oldToken = sessionPair.slice("session=".length);
    let payload;
    try {
      payload = jwt.verify(oldToken, jwtSecret);
    } catch {
      return { statusCode: 401, body: JSON.stringify({ error: "Invalid session token" }) };
    }

    // Vérification du code TOTP
    if (!payload.twoFASecret) {
      return { statusCode: 400, body: JSON.stringify({ error: "No 2FA secret in session" }) };
    }

    const valid = speakeasy.totp.verify({
      secret: payload.twoFASecret,
      encoding: "base32",
      token,
      window: 1
    });

    if (!valid) {
      return { statusCode: 401, body: JSON.stringify({ error: "Invalid 2FA code" }) };
    }

    // Nouveau JWT avec twoFA validé
    const newToken = jwt.sign(
      { email: payload.email, googleId: payload.googleId, twoFA: true },
      jwtSecret,
      { expiresIn: "15m" }
    );

    return {
      statusCode: 200,
      headers: {
        "Set-Cookie": `session=${newToken}; HttpOnly; Secure; Path=/; SameSite=Lax`,
        "Cache-Control": "no-store"
      },
      body: JSON.stringify({ valid: true, redirect: "/admin.html" })
    };

  } catch (err) {
    console.error("Erreur 2FA verify:", err);
    let message = "";
    if (err instanceof Error) {
      message = err.message;
    } else if (typeof err === "string") {
      message = err;
    } else {
      message = JSON.stringify(err);
    }
    return { statusCode: 500, body: JSON.stringify({ error: "Erreur vérification", details: message }) };
  }
};





